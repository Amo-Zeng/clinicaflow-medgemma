<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ClinicaFlow Console</title>
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <div class="brand-title">ClinicaFlow Console</div>
        <div class="brand-subtitle">Agentic triage copilot • demo UI</div>
      </div>
      <div class="top-actions">
        <span id="backendBadge" class="pill">backend: loading…</span>
        <span id="policyBadge" class="pill subtle">policy: loading…</span>
        <a class="btn subtle" href="/openapi.json" target="_blank" rel="noreferrer">OpenAPI</a>
        <a class="btn subtle" href="/metrics" target="_blank" rel="noreferrer">Metrics</a>
        <a class="btn subtle" href="/policy_pack" target="_blank" rel="noreferrer">Policy pack</a>
      </div>
    </header>

    <main class="container">
      <nav class="tabs" aria-label="Console tabs">
        <button class="tab active" data-tab="triage" type="button">Triage</button>
        <button class="tab" data-tab="demo" type="button">Demo</button>
        <button class="tab" data-tab="workspace" type="button">Workspace</button>
        <button class="tab" data-tab="regression" type="button">Regression</button>
        <button class="tab" data-tab="review" type="button">Review</button>
        <button class="tab" data-tab="about" type="button">About</button>
      </nav>

      <section id="tab-triage" class="tabpanel active">
        <div class="grid">
          <section class="panel">
            <div class="panel-head">
              <h2>Patient intake</h2>
              <div class="segmented" role="tablist" aria-label="Input mode">
                <button class="seg active" data-mode="form" type="button">Form</button>
                <button class="seg" data-mode="json" type="button">JSON</button>
              </div>
            </div>

            <div id="mode-form" class="mode-panel">
              <div class="form-grid">
                <div class="field span-2">
                  <label for="chiefComplaint">Chief complaint</label>
                  <textarea id="chiefComplaint" rows="3" placeholder="e.g., Chest pain radiating to left arm for 25 minutes"></textarea>
                </div>

                <div class="field span-2">
                  <label for="history">History (brief)</label>
                  <textarea id="history" rows="3" placeholder="PMH, onset, progression, key negatives (e.g., denies syncope)…"></textarea>
                </div>

                <div class="field">
                  <label for="age">Age</label>
                  <input id="age" type="number" min="0" step="1" placeholder="61" />
                </div>

                <div class="field">
                  <label for="sex">Sex</label>
                  <select id="sex">
                    <option value="">—</option>
                    <option value="female">female</option>
                    <option value="male">male</option>
                    <option value="other">other</option>
                  </select>
                </div>

                <div class="field">
                  <label for="hr">Heart rate</label>
                  <input id="hr" type="number" min="0" step="1" placeholder="128" />
                </div>

                <div class="field">
                  <label for="sbp">Systolic BP</label>
                  <input id="sbp" type="number" min="0" step="1" placeholder="92" />
                </div>

                <div class="field">
                  <label for="dbp">Diastolic BP</label>
                  <input id="dbp" type="number" min="0" step="1" placeholder="58" />
                </div>

                <div class="field">
                  <label for="temp">Temp (°C)</label>
                  <input id="temp" type="number" step="0.1" placeholder="37.9" />
                </div>

                <div class="field">
                  <label for="spo2">SpO₂ (%)</label>
                  <input id="spo2" type="number" min="0" max="100" step="1" placeholder="93" />
                </div>

                <div class="field">
                  <label for="rr">Resp. rate</label>
                  <input id="rr" type="number" min="0" step="1" placeholder="24" />
                </div>

                <div class="field span-2">
                  <label for="imageDesc">Image descriptions (1 per line)</label>
                  <textarea id="imageDesc" rows="3" placeholder="Portable chest image: mild bilateral interstitial opacities"></textarea>
                </div>

                <div class="field span-2">
                  <label for="imageFiles">Upload images (optional)</label>
                  <input id="imageFiles" type="file" accept="image/*" multiple />
                  <div id="imagePreview" class="image-preview"></div>
                  <div id="imageHint" class="small muted">
                    Images are kept in-memory for this browser session. Redacted audit bundles exclude images by default.
                  </div>
                </div>

                <div class="field span-2">
                  <label for="priorNotes">Prior notes (1 per line)</label>
                  <textarea id="priorNotes" rows="3" placeholder="Prior episode of exertional chest tightness last week"></textarea>
                </div>
              </div>
            </div>

            <div id="mode-json" class="mode-panel hidden">
              <div class="field">
                <label for="intakeJson">Intake JSON</label>
                <textarea id="intakeJson" class="mono" rows="18"></textarea>
              </div>
              <div class="row">
                <button id="applyJsonToForm" class="btn subtle" type="button">Apply to form</button>
                <button id="updateJsonFromForm" class="btn subtle" type="button">Update JSON from form</button>
              </div>
            </div>

            <div class="row">
              <select id="presetSelect" class="select"></select>
              <button id="loadPreset" class="btn subtle" type="button">Load</button>
              <button id="runTriage" class="btn primary" type="button">Run triage</button>
            </div>

            <div id="intakeError" class="alert hidden"></div>
            <div class="hint">
              Tip: For a “judge-friendly” demo, load a vignette, run triage, then expand <b>Agent trace</b> and download
              an <b>audit bundle</b>.
            </div>
          </section>

          <section class="panel">
            <div class="panel-head">
              <h2>Output</h2>
              <div class="small" id="statusLine">Ready.</div>
            </div>

            <div class="summary">
              <div class="card">
                <div class="k">Risk tier</div>
                <div class="row" style="margin-top: 0;">
                  <div id="riskTier" class="risk">—</div>
                  <span id="escalationPill" class="pill subtle">escalation: —</span>
                </div>
                <div id="careSetting" class="small">—</div>
                <div id="tierRationale" class="small muted">—</div>
                <div id="metaLine" class="small">request_id: — • latency: —</div>
              </div>
              <div class="card">
                <div class="k">Vitals (input)</div>
                <div id="vitalsSummary" class="small muted">—</div>
              </div>
              <div class="card">
                <div class="k">Risk scores (demo)</div>
                <div id="riskScores" class="small muted">—</div>
              </div>
              <div class="card">
                <div class="k">Differential</div>
                <ul id="differential" class="list"></ul>
                <div id="reasoningInfo" class="small muted">—</div>
              </div>
              <div class="card">
                <div class="k">Confidence & uncertainty</div>
                <div class="row" style="margin-top: 0;">
                  <div id="confidenceVal" class="mono">—</div>
                  <div class="bar"><div id="confidenceBar" class="bar-fill"></div></div>
                </div>
                <ul id="uncertainty" class="list"></ul>
              </div>
              <div class="card">
                <div class="k">Missing critical fields</div>
                <ul id="missingFields" class="list"></ul>
              </div>
              <div class="card">
                <div class="k">Red flags</div>
                <ul id="redFlags" class="list"></ul>
              </div>
              <div class="card">
                <div class="k">Next actions</div>
                <ol id="actions" class="list"></ol>
                <div id="actionsProgress" class="small muted">—</div>
              </div>
            </div>

            <details class="details" open>
              <summary>Clinician handoff</summary>
              <div id="handoff" class="prewrap muted">—</div>
            </details>

            <details class="details">
              <summary>Patient return precautions</summary>
              <div id="patientSummary" class="prewrap muted">—</div>
            </details>

            <details class="details">
              <summary>Structured intake (normalized)</summary>
              <pre id="structuredOut" class="pre mono">{}</pre>
            </details>

            <details class="details">
              <summary>Reasoning rationale</summary>
              <div id="rationale" class="prewrap muted">—</div>
            </details>

            <details class="details">
              <summary>Protocols & citations</summary>
              <div id="citations" class="citations muted">—</div>
            </details>

            <details class="details">
              <summary>Agent trace (audit-friendly)</summary>
              <div id="trace" class="trace"></div>
            </details>

            <div class="row">
              <button id="copyResult" class="btn subtle" type="button">Copy JSON</button>
              <button id="copyHandoff" class="btn subtle" type="button">Copy handoff</button>
              <button id="copyPatient" class="btn subtle" type="button">Copy precautions</button>
              <button id="copyNote" class="btn subtle" type="button">Copy note.md</button>
              <button id="downloadNote" class="btn subtle" type="button">Download note.md</button>
              <button id="downloadFhir" class="btn subtle" type="button">Download FHIR bundle</button>
              <button id="downloadReport" class="btn subtle" type="button">Download report.html</button>
              <button id="printReport" class="btn subtle" type="button">Print report</button>
              <button id="downloadRedacted" class="btn subtle" type="button">Download audit bundle (redacted)</button>
              <button id="downloadFull" class="btn subtle" type="button">Download audit bundle (full)</button>
            </div>

            <div id="runError" class="alert hidden"></div>
            <pre id="rawResult" class="pre mono">{}</pre>
          </section>
        </div>
      </section>

      <section id="tab-demo" class="tabpanel">
        <div class="grid">
          <section class="panel">
            <div class="panel-head">
              <h2>3-minute demo runbook</h2>
              <div class="small">Click buttons in order while recording.</div>
            </div>

            <ol class="runbook">
              <li>
                <div class="k">Show ops readiness</div>
                <div class="row">
                  <a class="btn subtle" href="/doctor" target="_blank" rel="noreferrer">Open /doctor</a>
                  <a class="btn subtle" href="/metrics" target="_blank" rel="noreferrer">Open /metrics</a>
                  <a class="btn subtle" href="/openapi.json" target="_blank" rel="noreferrer">OpenAPI</a>
                  <a class="btn subtle" href="/policy_pack" target="_blank" rel="noreferrer">Open /policy_pack</a>
                </div>
              </li>
              <li>
                <div class="k">High-acuity case (critical)</div>
                <div class="small muted">Chest pain + hypotension (ACS pathway).</div>
                <div class="row">
                  <button id="demoCritical" class="btn primary" type="button">Load + run</button>
                  <button id="demoDownloadAudit" class="btn subtle" type="button">Download redacted audit</button>
                  <button id="demoDownloadFhir" class="btn subtle" type="button">Download FHIR</button>
                  <button id="demoDownloadReport" class="btn subtle" type="button">Download report</button>
                  <button id="demoSaveWorkspace" class="btn subtle" type="button">Save run to workspace</button>
                </div>
              </li>
              <li>
                <div class="k">Neuro red-flag case (urgent)</div>
                <div class="small muted">Slurred speech + unilateral weakness (stroke pathway).</div>
                <div class="row">
                  <button id="demoNeuro" class="btn primary" type="button">Load + run</button>
                </div>
              </li>
              <li>
                <div class="k">Low-acuity case (routine)</div>
                <div class="small muted">Sore throat + runny nose (normal vitals).</div>
                <div class="row">
                  <button id="demoRoutine" class="btn primary" type="button">Load + run</button>
                </div>
              </li>
              <li>
                <div class="k">Regression benchmark (reproducibility)</div>
                <div class="row">
                  <button id="demoSynthetic" class="btn subtle" type="button">Run synthetic proxy</button>
                  <button id="demoRegression" class="btn primary" type="button">Run vignette benchmark</button>
                </div>
              </li>
              <li>
                <div class="k">Adversarial robustness (safety)</div>
                <div class="small muted">Abbreviations + negation + prompt-injection strings.</div>
                <div class="row">
                  <button id="demoAdversarial" class="btn primary" type="button">Load + run</button>
                </div>
              </li>
              <li>
                <div class="k">Clinician review tooling</div>
                <div class="row">
                  <button id="demoGoReview" class="btn subtle" type="button">Open Review tab</button>
                  <button id="demoGoWorkspace" class="btn subtle" type="button">Open Workspace tab</button>
                </div>
              </li>
            </ol>

            <div class="callout">
              <div class="k">Tip</div>
              <div class="small muted">
                For “real MedGemma” footage, start the demo with
                <code>REQUIRE_MEDGEMMA=1 MEDGEMMA_MODEL=&lt;HF_ID_OR_LOCAL_PATH&gt; bash scripts/demo_one_click.sh</code>
                so the backend badge shows <code>openai_compatible</code>.
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-head">
              <h2>Recording checklist</h2>
              <div class="small">Make judges’ lives easy.</div>
            </div>
            <ul class="checklist">
              <li>Say “decision support, not diagnosis”.</li>
              <li>Show deterministic safety escalation + rationale.</li>
              <li>Show audit bundle download (redacted).</li>
              <li>Show synthetic proxy benchmark (reproducible writeup numbers).</li>
              <li>Show regression benchmark tab + summary.</li>
              <li>Show clinician review export (no PHI).</li>
            </ul>
            <div class="callout">
              <div class="k">Video link placeholder</div>
              <div class="small muted mono">https://www.youtube.com/watch?v=vZgvNssSSGk</div>
            </div>
          </section>
        </div>
      </section>

      <section id="tab-workspace" class="tabpanel">
        <div class="grid">
          <section class="panel">
            <div class="panel-head">
              <h2>Case workspace</h2>
              <div class="small">Local-only storage for demo. Do not store PHI.</div>
            </div>

            <div class="row">
              <button id="wsSaveIntake" class="btn subtle" type="button">Save intake</button>
              <button id="wsSaveRun" class="btn primary" type="button">Save run</button>
              <button id="wsExport" class="btn subtle" type="button">Export JSON</button>
              <button id="wsImport" class="btn subtle" type="button">Import JSON</button>
              <button id="wsReset" class="btn subtle" type="button">Reset</button>
              <span id="wsStatus" class="small"></span>
            </div>
            <input id="wsImportFile" class="hidden" type="file" accept="application/json" />

            <div id="wsSummary" class="callout">
              <div class="k">Workspace summary</div>
              <div id="wsSummaryText" class="small muted">—</div>
            </div>

            <div class="tablewrap">
              <table>
                <thead>
                  <tr>
                    <th>Saved</th>
                    <th>Chief complaint</th>
                    <th>Risk tier</th>
                    <th>Backend</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="wsTableBody"></tbody>
              </table>
            </div>
          </section>

          <section class="panel">
            <div class="panel-head">
              <h2>Selected item</h2>
              <div class="small">Load into Triage tab for full trace.</div>
            </div>

            <pre id="wsSelected" class="pre mono">{}</pre>
            <div class="row">
              <button id="wsLoadIntoTriage" class="btn primary" type="button">Load into triage</button>
              <button id="wsDownloadReport" class="btn subtle" type="button">Download report</button>
              <button id="wsDownloadNote" class="btn subtle" type="button">Download note.md</button>
              <button id="wsDeleteSelected" class="btn subtle" type="button">Delete selected</button>
            </div>

            <div id="wsError" class="alert hidden"></div>
          </section>
        </div>
      </section>

      <section id="tab-regression" class="tabpanel">
        <section class="panel">
          <div class="panel-head">
            <h2>Vignette regression</h2>
            <div class="small">
              Built-in synthetic vignette regression sets:
              standard (n=30), adversarial (n=20), extended (n=100). See <code>docs/VIGNETTE_REGRESSION.md</code>.
            </div>
          </div>

          <div class="callout">
            <div class="k">Synthetic proxy benchmark (writeup)</div>
            <div class="small muted">Reproducible proxy metrics (seed=17, n=220). Runs locally on this demo server.</div>
            <div class="row" style="margin-top: 10px;">
              <button id="runSynthetic" class="btn subtle" type="button">Run synthetic</button>
              <button id="copySyntheticMd" class="btn subtle" type="button">Copy markdown</button>
              <button id="downloadSyntheticMd" class="btn subtle" type="button">Download markdown</button>
              <span id="syntheticStatus" class="small"></span>
            </div>
            <pre id="syntheticMd" class="pre mono" style="margin-top: 10px;"></pre>
          </div>

          <div class="row">
            <select id="benchSet" class="select">
              <option value="standard">standard</option>
              <option value="adversarial">adversarial</option>
              <option value="extended">extended</option>
              <option value="all">all</option>
              <option value="mega">mega</option>
            </select>
            <button id="runBench" class="btn primary" type="button">Run benchmark</button>
            <button id="downloadBench" class="btn subtle" type="button">Download JSON</button>
            <button id="copyBenchMd" class="btn subtle" type="button">Copy markdown</button>
            <button id="downloadBenchMd" class="btn subtle" type="button">Download markdown</button>
            <span id="benchStatus" class="small"></span>
          </div>

          <div class="row">
            <label class="check"><input id="filterMismatch" type="checkbox" /> Tier mismatches only</label>
            <label class="check"><input id="filterUnder" type="checkbox" /> Under-triage only</label>
            <label class="check"><input id="filterOver" type="checkbox" /> Over-triage only</label>
            <span class="small muted">Tip: click a row to load that case.</span>
          </div>

          <div id="benchSummary" class="bench-summary"></div>
          <div class="tablewrap">
            <table id="benchTable">
              <thead>
                <tr>
                  <th>Case</th>
                  <th>Gold tier</th>
                  <th>Baseline</th>
                  <th>ClinicaFlow</th>
                  <th>Gold categories</th>
                  <th>Pred categories</th>
                </tr>
              </thead>
              <tbody id="benchBody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <section id="tab-review" class="tabpanel">
        <div class="grid">
          <section class="panel">
            <div class="panel-head">
              <h2>Clinician review (qualitative)</h2>
              <div class="small">Collect real feedback on synthetic vignettes. No PHI.</div>
            </div>

            <div class="row">
              <select id="reviewSet" class="select">
                <option value="standard">standard</option>
                <option value="adversarial">adversarial</option>
                <option value="extended">extended</option>
                <option value="mega">mega</option>
              </select>
              <select id="reviewCaseSelect" class="select"></select>
              <button id="reviewLoadCase" class="btn subtle" type="button">Load case</button>
              <button id="reviewRunTriage" class="btn primary" type="button">Run triage</button>
              <label class="check"><input id="reviewShowGold" type="checkbox" /> Show gold labels</label>
            </div>

            <div class="review-split">
              <div>
                <div class="k">Intake (synthetic)</div>
                <pre id="reviewIntake" class="pre mono">{}</pre>
              </div>
              <div>
                <div class="k">ClinicaFlow output (key fields)</div>
                <pre id="reviewOutput" class="pre mono">{}</pre>
              </div>
            </div>

            <details class="details hidden">
              <summary>Gold label (for regression only)</summary>
              <pre id="reviewGold" class="pre mono">{}</pre>
            </details>

            <div id="reviewError" class="alert hidden"></div>
          </section>

          <section class="panel">
            <div class="panel-head">
              <h2>Reviewer inputs</h2>
              <div class="small">Saved locally in your browser.</div>
            </div>

            <div class="form-grid">
              <div class="field">
                <label for="reviewRole">Reviewer role / specialty</label>
                <input id="reviewRole" type="text" placeholder="e.g., primary care physician" />
              </div>
              <div class="field">
                <label for="reviewYears">Years in practice (optional)</label>
                <input id="reviewYears" type="number" min="0" step="1" placeholder="8" />
              </div>
              <div class="field span-2">
                <label for="reviewSetting">Setting (optional)</label>
                <input id="reviewSetting" type="text" placeholder="e.g., community clinic / urgent care" />
              </div>
              <div class="field">
                <label for="reviewDate">Date</label>
                <input id="reviewDate" type="date" />
              </div>
              <div class="field">
                <label for="reviewRiskSafety">Risk tier safety</label>
                <select id="reviewRiskSafety">
                  <option value="">—</option>
                  <option value="safe">safe</option>
                  <option value="borderline">borderline</option>
                  <option value="unsafe">unsafe</option>
                </select>
              </div>
              <div class="field">
                <label for="reviewActionability">Actionability (1–5)</label>
                <select id="reviewActionability">
                  <option value="">—</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                </select>
              </div>
              <div class="field">
                <label for="reviewHandoff">Handoff quality (1–5)</label>
                <select id="reviewHandoff">
                  <option value="">—</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                </select>
              </div>
              <div class="field span-2">
                <label for="reviewFeedback">Qualitative feedback (free text)</label>
                <textarea id="reviewFeedback" rows="5" placeholder="Missing red flags? Unsafe actions? Workflow fit?"></textarea>
              </div>
              <div class="field span-2">
                <label for="reviewImprovement">Top improvement suggestion</label>
                <textarea id="reviewImprovement" rows="3" placeholder="What would make this more usable/safe?"></textarea>
              </div>
            </div>

            <div class="row">
              <button id="reviewSave" class="btn primary" type="button">Save review</button>
              <button id="reviewClear" class="btn subtle" type="button">Clear form</button>
              <button id="reviewDownloadJson" class="btn subtle" type="button">Download JSON</button>
              <button id="reviewDownloadMd" class="btn subtle" type="button">Download markdown</button>
            </div>

            <details class="details">
              <summary>Writeup paragraph helper</summary>
              <div class="small muted">Fill these in to produce a copy-paste paragraph for the Kaggle writeup.</div>
              <div class="form-grid" style="margin-top: 10px;">
                <div class="field span-2">
                  <label for="writeupNoted1">Noted (1)</label>
                  <input id="writeupNoted1" type="text" placeholder="e.g., red-flag escalation was appropriately conservative" />
                </div>
                <div class="field span-2">
                  <label for="writeupNoted2">Noted (2)</label>
                  <input id="writeupNoted2" type="text" placeholder="e.g., next-action checklist was actionable" />
                </div>
                <div class="field span-2">
                  <label for="writeupNoted3">Noted (3)</label>
                  <input id="writeupNoted3" type="text" placeholder="e.g., wording of return precautions was clear" />
                </div>
                <div class="field span-2">
                  <label for="writeupHelpful">Most helpful aspect</label>
                  <input id="writeupHelpful" type="text" placeholder="e.g., deterministic safety escalation + audit trace" />
                </div>
                <div class="field span-2">
                  <label for="writeupImprove">Top improvement area</label>
                  <input id="writeupImprove" type="text" placeholder="e.g., reduce over-triage in low acuity cases" />
                </div>
              </div>

              <div class="row">
                <button id="reviewCopyParagraph" class="btn subtle" type="button">Copy paragraph</button>
              </div>
              <pre id="reviewParagraph" class="pre mono"></pre>
            </details>

            <div class="k" style="margin-top: 10px;">Saved reviews</div>
            <div class="tablewrap">
              <table>
                <thead>
                  <tr>
                    <th>Case</th>
                    <th>Set</th>
                    <th>Pred tier</th>
                    <th>Safety</th>
                    <th>Actionability</th>
                    <th>Handoff</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="reviewTableBody"></tbody>
              </table>
            </div>

            <div class="row">
              <button id="reviewReset" class="btn subtle" type="button">Reset local reviews</button>
            </div>
          </section>
        </div>
      </section>

      <section id="tab-about" class="tabpanel">
        <section class="panel">
          <h2>About</h2>
          <p class="muted">
            This demo UI is designed for showcasing an <b>agentic</b>, <b>auditable</b> triage workflow. It is not a diagnostic device.
            Always involve licensed clinicians and validate on site-specific data before any deployment.
          </p>

          <div class="callout">
            <div class="k">One-click demo</div>
            <div class="mono">bash scripts/demo_one_click.sh</div>
            <div class="small muted">Optionally auto-starts a local MedGemma vLLM server if <code>MEDGEMMA_MODEL</code> is set.</div>
          </div>

          <div class="callout">
            <div class="k">Clinician review (qualitative; do not fabricate)</div>
            <div class="mono">clinicaflow benchmark review_packet --set standard --out reviews/clinician_review_packet.md --include-gold</div>
          </div>

          <div class="callout">
            <div class="k">Policy pack viewer (demo; replace with site protocols)</div>
            <div class="small muted">Shows the currently loaded policy pack (IDs, triggers, recommended actions) and its sha256 for governance.</div>
            <div class="row" style="margin-top: 10px;">
              <button id="loadPolicyPack" class="btn subtle" type="button">Load</button>
              <button id="copyPolicyPack" class="btn subtle" type="button">Copy JSON</button>
            </div>
            <pre id="policyPackJson" class="pre mono" style="margin-top: 10px;">{}</pre>
          </div>
        </section>
      </section>
    </main>

    <script src="/static/app.js"></script>
  </body>
</html>
